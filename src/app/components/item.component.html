<p-toast />

<p-dialog
  [closable]="false"
  [draggable]="false"
  [modal]="true"
  [visible]="state === State.Loading"
  contentStyleClass="w-30rem"
>
  <ng-template pTemplate="header">
    <app-icon-label
      class="p-dialog-title"
      [icon]="PrimeIcons.HOURGLASS"
      label="Loading documents..."
    />
  </ng-template>

  <ng-template pTemplate="content">
    <div class="container flex-column align-items-center">
      <p-progressSpinner />
      <app-icon-label [icon]="PrimeIcons.DATABASE" label="Database: {{ server() }}" />
      <app-icon-label [icon]="PrimeIcons.TABLE" label="Collection: {{ item() }}" />
    </div>
  </ng-template>

  <ng-template pTemplate="footer">
    <p-button
      [disabled]="!lastRefresh"
      [icon]="PrimeIcons.TIMES"
      (onClick)="cancelRefresh()"
      label="Cancel"
      severity="danger"
    />
  </ng-template>
</p-dialog>

<p-dialog
  [closable]="false"
  [draggable]="false"
  [modal]="true"
  [visible]="state === State.Errored"
  contentStyleClass="w-30rem"
>
  <ng-template pTemplate="header">
    <app-icon-label
      class="p-dialog-title"
      [icon]="PrimeIcons.EXCLAMATION_TRIANGLE"
      label="An error occurred"
    />
  </ng-template>

  <ng-template pTemplate="content">
    <div class="container flex-column">
      <app-icon-label [icon]="PrimeIcons.DATABASE" label="Database: {{ server() }}" />
      <app-icon-label [icon]="PrimeIcons.TABLE" label="Collection: {{ item() }}" />
      <div></div>
      <p-panel [collapsed]="true" [toggleable]="true" header="Error details">
        <ng-template pTemplate="content">
          <app-icon-label
            class="text-danger"
            [label]="lastError.name"
            [icon]="PrimeIcons.TIMES_CIRCLE"
          />
          <div class="pl-4">
            {{ lastError.message }}
          </div>
        </ng-template>
      </p-panel>
    </div>
  </ng-template>

  <ng-template pTemplate="footer">
    <p-button
      [outlined]="true"
      [icon]="PrimeIcons.ARROW_LEFT"
      routerLink="../"
      label="Back"
      severity="secondary"
    />
    <p-button
      [icon]="PrimeIcons.REFRESH"
      (onClick)="refreshData()"
      label="Refresh"
      severity="primary"
    />
  </ng-template>
</p-dialog>

<p-dialog
  [(visible)]="chooseExportVisible"
  [dismissableMask]="true"
  [draggable]="false"
  [modal]="true"
  [resizable]="false"
  styleClass="w-6"
>
  <ng-template pTemplate="header">
    <app-icon-label
      class="p-dialog-title"
      [icon]="PrimeIcons.FILE_EXPORT"
      label="Choose documents export format"
    />
  </ng-template>

  <ng-template pTemplate="content">
    <div class="container">
      <p-chips
        class="w-full"
        [(ngModel)]="exportData"
        [autofocus]="true"
        [disabled]="exportData.length === 1"
        (onFocus)="removeChipsInput($event)"
        styleClass="w-full"
      >
        <ng-template let-item pTemplate="item">
          <app-icon-label [label]="item.id" [icon]="PrimeIcons.FILE" />
        </ng-template>
      </p-chips>
      <!-- TODO: empty exportData -->
      <!-- embed? -->
    </div>
  </ng-template>

  <ng-template pTemplate="footer">
    <p-button
      (onClick)="chosenExportData(ExportType.JSON)"
      badge="{;}"
      label="JSON"
      severity="primary"
    />
    <p-button
      [outlined]="true"
      (onClick)="chosenExportData(ExportType.CSV)"
      badge="{,}"
      label="CSV"
      severity="secondary"
    />
  </ng-template>
</p-dialog>

<p-confirmDialog
  [dismissableMask]="true"
  [icon]="PrimeIcons.TRASH"
  acceptButtonStyleClass="p-button-danger"
  acceptLabel="Delete"
  rejectButtonStyleClass="p-button-outlined"
  rejectLabel="Cancel"
  styleClass="w-6"
>
  <ng-template pTemplate="header">
    <app-icon-label
      class="p-dialog-title"
      [icon]="PrimeIcons.MINUS_CIRCLE"
      label="Confirm documents delete"
    />
  </ng-template>

  <ng-template pTemplate="message">
    <div class="container w-full">
      <p-chips
        class="px-4 w-full"
        [(ngModel)]="deleteData"
        [autofocus]="true"
        [disabled]="deleteData.length === 1"
        (onFocus)="removeChipsInput($event)"
        styleClass="w-full"
      >
        <ng-template let-item pTemplate="item">
          <app-icon-label [label]="item.id" [icon]="PrimeIcons.FILE" />
        </ng-template>
      </p-chips>
      <!-- TODO: empty deleteData -->
      <!-- dependent? -->
    </div>
  </ng-template>
</p-confirmDialog>

<p-contextMenu #context [model]="contextMenu" />

<p-table
  [(contextMenuSelection)]="contextDatum"
  [(selection)]="selectedData"
  [columns]="selectedColumns.length ? selectedColumns : columns"
  [contextMenu]="context"
  [lazy]="true"
  [loading]="state === State.Loading"
  [paginator]="true"
  [rowsPerPageOptions]="[10, 25, 50]"
  [rows]="10"
  [scrollable]="true"
  [showJumpToPageDropdown]="true"
  [totalRecords]="paginatedData.items"
  [value]="paginatedData.data"
  (onLazyLoad)="refreshData()"
  dataKey="id"
  editMode="row"
  scrollHeight="flex"
  sortMode="multiple"
  styleClass="p-datatable-gridlines p-datatable-striped"
>
  <ng-template pTemplate="caption">
    <p-toolbar styleClass="border-noround-bottom">
      <ng-template pTemplate="start">
        <div class="container">
          <p-fileUpload
            [auto]="true"
            [customUpload]="true"
            (uploadHandler)="handleImportData($event)"
            accept=".csv,.json"
            chooseIcon="pi pi-download"
            chooseLabel="Import"
            mode="basic"
          />
          <p-splitButton
            [buttonDisabled]="!selectedData.length"
            [model]="exportMenu"
            (onClick)="chooseExportData(ActionType.Selection)"
            icon="pi pi-upload"
            label="Export"
            severity="help"
          />
        </div>
      </ng-template>

      <ng-template pTemplate="center">
        <h1 class="my-0">
          <i class="pi pi-table text-2xl"></i>
          Collection: {{ item() }}
        </h1>
      </ng-template>

      <ng-template pTemplate="end">
        <div class="container">
          <p-button [disabled]="true" icon="pi pi-plus" label="Add" severity="success" />
          <p-splitButton
            [buttonDisabled]="!selectedData.length"
            [model]="deleteMenu"
            (onClick)="confirmDeleteData(ActionType.Selection)"
            icon="pi pi-trash"
            label="Delete"
            severity="danger"
            tooltip="All documents in selected collections will be deleted"
          />
          <p-splitButton [disabled]="true" icon="pi pi-clone" label="Clone" severity="info" />
        </div>
      </ng-template>
    </p-toolbar>

    <p-toolbar styleClass="border-noround-top">
      <ng-template pTemplate="left">
        <div class="container">
          <p-button
            [outlined]="true"
            [icon]="PrimeIcons.ARROW_LEFT"
            routerLink="../"
            label="Back"
            severity="secondary"
          />
          <div
            class="select-none"
            [badgeDisabled]="!lastRefresh"
            [severity]="getRefreshSeverity()"
            [value]="(lastRefresh | date:'shortTime')!"
            pBadge
          >
            <p-button
              [outlined]="true"
              (onClick)="refreshData()"
              icon="pi pi-refresh"
              label="Refresh"
            />
          </div>
        </div>
      </ng-template>

      <ng-template pTemplate="right">
        <div class="container">
          <p-multiSelect
            [(ngModel)]="selectedColumns"
            [loading]="state === State.Loading"
            [options]="columns"
            [showClear]="true"
            display="chip"
            placeholder="Select fields..."
          />
          <p-button
            [outlined]="true"
            (onClick)="resetTable()"
            icon="pi pi-filter-slash"
            label="Clear"
          />
        </div>
      </ng-template>
    </p-toolbar>
  </ng-template>

  <ng-template let-columns pTemplate="header">
    <tr>
      <th class="w-1rem" pFrozenColumn>
        <p-tableHeaderCheckbox />
      </th>
      <th pFrozenColumn pSortableColumn="id">
        <i class="pi pi-file"></i> id
        <p-sortIcon field="id" />
      </th>
      @for (column of columns; track column) {
        <th [pSortableColumn]="column">
          <i class="pi" [class]="foreignColumns.has(column) ? 'pi-key' : 'pi-list'"></i>
          {{ column }}
          <p-sortIcon [field]="column" />
        </th>
      }
      <th class="w-9rem" alignFrozen="right" pFrozenColumn><i class="pi pi-file-edit"></i> Edit</th>
    </tr>
  </ng-template>

  <ng-template let-columns="columns" let-datum let-editing="editing" pTemplate="body">
    <tr [pContextMenuRow]="datum" [pEditableRow]="datum" [pSelectableRow]="datum">
      <td pFrozenColumn>
        <p-tableCheckbox [value]="datum" />
      </td>
      <td pFrozenColumn>
        <p-button [label]="datum.id" [link]="true" [routerLink]="datum.id" />
      </td>
      @for (column of columns; track column) {
        <td>
          <p-cellEditor>
            <ng-template pTemplate="input">
              <input
                class="min-w-full"
                [(ngModel)]="datum[column]"
                [disabled]="isEditColumnDisabled(datum[column])"
                (keydown.home)="$event.stopPropagation()"
                (keydown.end)="$event.stopPropagation()"
                pInputText
                type="text"
              />
            </ng-template>

            <ng-template pTemplate="output">
              @if (foreignColumns.has(column)) {
                <p-button
                  [label]="datum[column]"
                  [link]="true"
                  [routerLink]="['../', foreignColumns.get(column), datum[column]]"
                />
              } @else {
                {{ datum[column] }}
              }
            </ng-template>
          </p-cellEditor>
        </td>
      }
      <td alignFrozen="right" pFrozenColumn>
        <div class="flex justify-content-center gap-2">
          @if (editing) {
            <p-button
              (onClick)="saveEditData(datum)"
              icon="pi pi-check"
              pSaveEditableRow
              severity="success"
            />
            <p-button
              (onClick)="cancelEditData(datum)"
              icon="pi pi-times"
              pCancelEditableRow
              severity="danger"
            />
          } @else {
            <p-button
              (onClick)="initEditData(datum)"
              icon="pi pi-pencil"
              pInitEditableRow
              severity="warning"
            />
          }
        </div>
      </td>
    </tr>
  </ng-template>

  <ng-template pTemplate="emptymessage">
    <tr>
      <td class="text-center" colspan="100%">
        <h4 class="p-badge-warning">No document found</h4>
      </td>
    </tr>
  </ng-template>
</p-table>
