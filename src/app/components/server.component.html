<p-toast />

<p-contextMenu #context [model]="contextMenu" />

<p-confirmDialog
  [dismissableMask]="true"
  header="Delete collection(s)"
  icon="pi pi-trash"
  rejectButtonStyleClass="p-button-outlined"
  styleClass="w-30rem"
/>

<p-dialog
  [(visible)]="exportVisible"
  [dismissableMask]="true"
  [draggable]="false"
  [modal]="true"
  [resizable]="false"
  contentStyleClass="w-30rem"
>
  <ng-template pTemplate="header">
    <h2>
      <i class="pi pi-file-export"></i>
      Export collection(s)
    </h2>
  </ng-template>

  <ng-template pTemplate="content">
    {{ exportMessage }}
  </ng-template>

  <ng-template pTemplate="footer">
    <p-button
      [outlined]="true"
      (onClick)="exportItems(ExportType.CSV)"
      badge="{,}"
      label="CSV"
      severity="secondary"
    />
    <p-button
      (onClick)="exportItems(ExportType.JSON)"
      badge="{;}"
      label="JSON"
      severity="primary"
    />
  </ng-template>
</p-dialog>

<p-dialog
  [closable]="false"
  [draggable]="false"
  [modal]="true"
  [visible]="state === State.Loading"
  contentStyleClass="w-30rem"
>
  <ng-template pTemplate="header">
    <h2>
      <i class="pi pi-spin pi-spinner"></i>
      Loading...
    </h2>
  </ng-template>

  <ng-template pTemplate="content">
    <i class="pi pi-database"></i>
    Database: {{ server() }}
  </ng-template>

  <ng-template pTemplate="footer">
    <p-button (onClick)="cancelRefresh()" icon="pi pi-times" label="Cancel" severity="warning" />
  </ng-template>
</p-dialog>

<p-dialog
  [closable]="false"
  [draggable]="false"
  [modal]="true"
  [visible]="state === State.Errored"
  contentStyleClass="w-30rem"
>
  <ng-template pTemplate="header">
    <h2>
      <i class="pi pi-exclamation-circle"></i>
      Error
    </h2>
  </ng-template>

  <ng-template pTemplate="content">
    <i class="pi pi-database"></i>
    Database: {{ server() }}
    <p-messages [value]="messageError" />
  </ng-template>

  <ng-template pTemplate="footer">
    <p-button
      [outlined]="true"
      [routerLink]="['..']"
      icon="pi pi-arrow-left"
      label="Back"
      severity="secondary"
    />
    <p-button (onClick)="refreshItems()" icon="pi pi-refresh" label="Refresh" severity="primary" />
  </ng-template>
</p-dialog>

<p-table
  [(contextMenuSelection)]="selectedItem"
  [(selection)]="selectedItems"
  [contextMenu]="context"
  [scrollable]="true"
  [sortOrder]="1"
  [value]="items"
  dataKey="name"
  scrollHeight="flex"
  sortField="name"
  styleClass="p-datatable-gridlines p-datatable-striped"
>
  <ng-template pTemplate="caption">
    <p-toolbar>
      <ng-template pTemplate="start">
        <div class="flex gap-2">
          <p-fileUpload
            [auto]="true"
            [customUpload]="true"
            (uploadHandler)="importItems($event)"
            accept=".csv,.json"
            chooseIcon="pi pi-download"
            chooseLabel="Import"
            mode="basic"
          />
          <p-splitButton
            [buttonDisabled]="!selectedItems.length"
            [model]="exportMenu"
            (onClick)="chooseExportItems(ActionType.Selection)"
            icon="pi pi-upload"
            label="Export"
            severity="help"
          />
        </div>
      </ng-template>

      <ng-template pTemplate="center">
        <h1>
          <i class="pi pi-database text-2xl"></i>
          Database: {{ server() }}
        </h1>
      </ng-template>

      <ng-template pTemplate="end">
        <div class="flex gap-2">
          <p-button [disabled]="true" icon="pi pi-plus" label="Add" severity="success" />
          <p-splitButton
            [buttonDisabled]="!selectedItems.length"
            [model]="deleteMenu"
            (onClick)="confirmDeleteItems(ActionType.Selection)"
            icon="pi pi-trash"
            label="Delete"
            severity="danger"
            tooltip="All documents in selected collections will be deleted"
          />
        </div>
      </ng-template>
    </p-toolbar>

    <p-toolbar>
      <ng-template pTemplate="left">
        <div
          class="select-none"
          [badgeDisabled]="!lastRefresh"
          [value]="(lastRefresh | date:'shortTime') ?? ''"
          pBadge
        >
          <p-button
            [outlined]="true"
            (onClick)="refreshItems()"
            icon="pi pi-refresh"
            label="Refresh"
          />
        </div>
      </ng-template>

      <ng-template pTemplate="right">
        <div class="flex gap-2">
          <p-inputGroup>
            <p-inputGroupAddon>
              <i class="pi pi-search"></i>
            </p-inputGroupAddon>
            <input
              #search
              (input)="filterTable(search.value)"
              pInputText
              placeholder="Search..."
              type="text"
            />
            <button
              [disabled]="!search.value"
              (click)="clearSearch()"
              icon="pi pi-times"
              pButton
              severity="danger"
              type="button"
            ></button>
          </p-inputGroup>
          <p-button
            [outlined]="true"
            (onClick)="resetTable()"
            icon="pi pi-filter-slash"
            label="Clear"
          />
        </div>
      </ng-template>
    </p-toolbar>
  </ng-template>

  <ng-template pTemplate="header">
    <tr>
      <th class="w-1rem" pFrozenColumn>
        <p-tableHeaderCheckbox />
      </th>
      <th pFrozenColumn pSortableColumn="name">
        <i class="pi pi-list"></i> Collection
        <p-sortIcon field="name" />
      </th>
      <th pSortableColumn="length">
        <i class="pi pi-hashtag"></i> Objects
        <p-sortIcon field="length" />
      </th>
      <th class="w-1" pSortableColumn="length">
        <i class="pi pi-percentage"></i> Objects
        <p-sortIcon field="length" />
      </th>
    </tr>
  </ng-template>

  <ng-template let-item pTemplate="body">
    <tr [pContextMenuRow]="item">
      <td pFrozenColumn>
        <p-tableCheckbox [value]="item" />
      </td>
      <td pFrozenColumn>
        <a [routerLink]="item.name">{{ item.name }}</a>
      </td>
      <td>
        {{ item.length | number }}
      </td>
      <td>
        {{ (item.length / itemsTotalLength) | percent }}
      </td>
    </tr>
  </ng-template>

  <ng-template pTemplate="emptymessage">
    <tr>
      <td class="text-center" colspan="100%">
        <h4 class="p-badge-warning">No collections found</h4>
      </td>
    </tr>
  </ng-template>
</p-table>
